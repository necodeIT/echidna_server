name: CI/Coverage

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  dart-check:
    name: Coverage Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“š Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ¦ Set up Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: ðŸ“¦ Install dependencies
        run: dart pub get
      
      - name: ðŸ“ Copy .env.example to .env
        run: cp .env.example .env

      - name: ðŸ˜ Setup PostgreSQL
        uses: ikalnytskyi/action-setup-postgres@v6

      - name: ðŸ“¦ Install Prisma
        run: npm install prisma -g
      
      - name: ðŸ˜ Push database
        run: prisma db push

      - name: ðŸ§ª Run tests
        run: |
          dart run coverage:test_with_coverage
          
          # Keep only entries for handlers/.dart files (these are the files actually doing the business logic)
          sed -n '/SF:.*handlers\/.*\.dart/,$p' coverage/lcov.info > filtered_lcov.info
          mv filtered_lcov.info coverage/lcov.info
        continue-on-error: true

      - name: ðŸ“Š Generate Coverage
        id: coverage-report
        uses: whynotmake-it/dart-coverage-assistant@v1.1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          lower_threshold: 20
          upper_threshold: 90
          compare_against_base: false