name: CI/Coverage

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  dart-check:
    name: Coverage Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“š Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ¦ Set up Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      
      - name: ğŸ“ Copy .env.example to .env
        run: cp .env.example .env

      - name: ğŸ˜ Install PostgreSQL
        run: sudo apt-get install postgresql postgresql-contrib

      - name: ğŸ˜ Start PostgreSQ
        run: sudo service postgresql start

      - name: ğŸ“¦ Install Prisma
        run: npm install prisma -g
      
      - name: ğŸ˜ Push database
        run: prisma db push

      - name: ğŸ“Š Generate Coverage
        id: coverage-report
        uses: whynotmake-it/dart-coverage-assistant@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          lower_threshold: 50
          upper_threshold: 90